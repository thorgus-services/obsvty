---
description: "Testing strategy for safe refactoring"
alwaysApply: true
---
# Testing Safety Net

## Critical Path Requirements
✅ **Core layer must have ≥85% branch coverage:**
```python
# tests/core/test_trace_context.py
def test_trace_context_rejects_invalid_prefix():
    with pytest.raises(InvalidTraceId, match="missing required prefix"):
        TraceContext(
            trace_id="invalid-123", 
            service_name="api",
            start_time=datetime.now()
        )
```

✅ **Integration tests for adapter contracts:**
```python
# tests/adapters/test_grpc_service.py
def test_grpc_service_rejects_unmasked_pii(grpc_channel, unmasked_trace_request):
    stub = TraceServiceStub(grpc_channel)
    with pytest.raises(grpc.RpcError) as exc:
        stub.ProcessTrace(unmasked_trace_request)
    assert exc.value.code() == grpc.StatusCode.FAILED_PRECONDITION
    assert "Sensitive data detected" in exc.value.details()
```

## Test Naming Convention
✅ **Use case focused names:**
```python
def test_ingest_trace_with_valid_context_returns_obsv_prefix_id():
    # Given
    trace = TraceContext(
        trace_id="obsv-123", 
        service_name="auth-service",
        start_time=datetime.now()
    )
    
    # When
    result = trace_processor.ingest_trace(trace)
    
    # Then
    assert result.trace_id.startswith("obsv-")
```

❌ **Blocked anti-patterns:**
- `# TODO: write test` in merged code
- Mocking core logic in adapter tests
- Tests with `time.sleep()` for async operations
- Unit tests that start full HTTP servers

## Obsvty-Specific Metrics
- **Core purity score:** % of core/ files with zero infra dependencies (target: 100%)
- **Privacy coverage:** % of data flows with masking validation (target: 100%)
- **Contract tests:** All .proto changes must have backward compatibility tests